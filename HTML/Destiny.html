<!DOCTYPE html>
<html>
<head>
<title>Page Title</title>
</head>
    <script src="../JS/User.js"></script>
    
<body>
    <h1 id="header"></h1>
    <img id="image">

    
    
    
    
    <button id="btn">run</button>
    
    <script type="text/javascript">
        var btn = document.getElementById("btn");
        var base = "https://www.bungie.net/Platform";
        var apiKey = "2b4611e007ce4f3bb7883a96ab26fd2e";
        //var user;
        

        
        function getItemData(hashId){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "../PHP/cache/world_sql_content_4538153d085eb7c87e59c58aefc70fb1.content.zip", true);
            //xhr.setRequestHeader("X-API-Key", apiKey);
            xhr.onreadystatechange = function(){
                
                if(this.readyState === 4 && this.status === 200){
                    var json = JSON.parse(this.responseText);
                    console.log(json)
                }
            }
            xhr.send()
        }
        
        function getItemInfo(ID, type, characterId, itemId){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "https://www.bungie.net/Platform/Destiny2/" + type + "/Profile/" + ID + "/Item/" + itemId + "/?components=307", true);
            xhr.setRequestHeader("X-API-Key", apiKey);
            xhr.onreadystatechange = function(){
                
                if(this.readyState === 4 && this.status === 200){
                    var json = JSON.parse(this.responseText);
                    console.log(json)
                }
            }
            xhr.send()
        }
        
        
        function getCharacterInfo(ID, type, characterId){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "https://www.bungie.net/Platform/Destiny2/" + type + "/Profile/" + ID + "/Character/" + characterId + "/?components=200, 205", true);
            xhr.setRequestHeader("X-API-Key", apiKey);
            xhr.onreadystatechange = function(){
                
                if(this.readyState === 4 && this.status === 200){
                    var json = JSON.parse(this.responseText);
                    //console.log(json);
                    //console.log(json.Response.equipment.data.items);
                    //for(var i = 0; i < json.Response.equipment.data.items.length; i++){
                        getItemInfo(ID, type, characterId, json.Response.equipment.data.items[0].itemInstanceId);
                        //getItemData(json.Response.equipment.data.items[0].itemHash);
                    //}
               // console.log("ID:" + ID + " type:" + type + "char:"  + characterId);
                }
                
            }
            xhr.send();
        }
        
        
        function getCharacters(ID, type) {
            
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "https://www.bungie.net/Platform/Destiny2/" + type + "/Profile/" + ID + "/?components=100", true);
            xhr.setRequestHeader("X-API-Key", apiKey);
            xhr.onreadystatechange = function(){
                
                if(this.readyState === 4 && this.status === 200){
                    var json = JSON.parse(this.responseText);
                    var profile = json.Response;
                    //console.log(json);
                    //console.log(profile.profile.data.characterIds);
                    
                    
                    for(var i = 0; i < profile.profile.data.characterIds.length; i++){
                        //console.log(profile.profile.data.characterIds[i]);
                        //console.log("character: " + i);
                        getCharacterInfo(ID, type, profile.profile.data.characterIds[i]);
                    }
                }
            }
            xhr.send();
        }
        
        
        btn.onclick = function createUser() {
            var name = "Khalidium";
            var xhr = new XMLHttpRequest();

            xhr.open("GET", "https://www.bungie.net/Platform/Destiny2/SearchDestinyPlayer/-1/" + name, true);
            xhr.setRequestHeader("X-API-Key", apiKey);
            xhr.onreadystatechange = function(){
                if(this.readyState === 4 && this.status === 200){
                    var json = JSON.parse(this.responseText);
                    var users = json.Response;
                    //console.log(users[0]);
                    //user = new User(users[0].displayName, users[0].membershipId, users[0].membershipType);
                    getCharacters(users[0].membershipId, users[0].membershipType);
                    
                }
            }
            xhr.send();
        
        };
        
       function manifestLink(){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "https://www.bungie.net/Platform/Destiny2/Manifest/", true);
            xhr.setRequestHeader("X-API-Key", apiKey);
            xhr.onreadystatechange = function(){
                if(this.readyState === 4 && this.status === 200){
                    var json = JSON.parse(this.responseText);
                    console.log(json);
                }
            }
            xhr.send();
        }
        
        
        
        
        
    </script>
</body>
</html>